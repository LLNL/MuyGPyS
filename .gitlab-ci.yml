variables:
  PYTHON_ENVIRONMENT_PATH: $CI_BUILDS_DIR/python-muyscans

stages:
  - environment
  - test

configure_python:
  stage: environment
  tags:
    - quartz
    - shell
  script:
    - virtualenv --python=/usr/tce/bin/python3-3.8.2 ${PYTHON_ENVIRONMENT_PATH}
    - source ${PYTHON_ENVIRONMENT_PATH}/bin/activate
    - pip install -r requirements.txt
    - pip install -e .
    - python -c "import muyscans"

.template_env_load:
  before_script:
    - source ${PYTHON_ENVIRONMENT_PATH}/bin/activate

test_data:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - python tests/data.py

test_gp:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - python tests/gp.py

test_neighbors:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - python tests/neighbors.py

test_optimize:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - srun -N1 -ppdebug python tests/optimize.py

test_predict:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - python tests/predict.py

test_api:
  extends: .template_env_load
  stage: test
  tags:
    - quartz
    - shell
  script:
    - srun -N1 -ppdebug python tests/api.py /p/lustre1/madstare/muygps-data/star-gal/

